###############################################
# Глобальные настройки HAProxy
###############################################
global
    # Логирование в stdout (подходит для docker-контейнера)
    log stdout format raw local0

    # Максимальное количество одновременных соединений
    maxconn 2000

    # Запуск в фоновом режиме (демон)
    daemon

###############################################
# Настройки по умолчанию для всех фронтендов и бэкендов
###############################################
defaults
    log global                 # наследуем глобальные настройки логирования
    mode tcp                    # TCP режим (не HTTP)
    option tcplog               # логируем TCP-соединения
    timeout connect 5s          # таймаут установления соединения
    timeout client 10m          # таймаут активности клиента
    timeout server 10m          # таймаут активности сервера
    retries 3                   # число повторов при неудаче

###############################################
# Frontend для AMQP (порт 5672)
###############################################
frontend amqp
    bind *:5672                 # слушаем все интерфейсы на порту 5672
    default_backend rabbitmq_amqp
    timeout client 10m

###############################################
# Backend для AMQP
###############################################
backend rabbitmq_amqp
    mode tcp
    option tcp-check             # проверка доступности TCP-серверов
    tcp-check connect            # простая TCP-проверка
    balance leastconn            # балансировка по наименьшему числу соединений

    # Основной сервер
    server rabbitmq1 rabbitmq1:5672 check inter 3000 rise 2 fall 3
    # Резервные серверы
    server rabbitmq2 rabbitmq2:5672 check inter 3000 rise 2 fall 3 backup
    server rabbitmq3 rabbitmq3:5672 check inter 3000 rise 2 fall 3 backup

    timeout server 10m

###############################################
# Frontend для Management UI (порт 15672)
###############################################
frontend mgmt
    bind *:15672
    default_backend rabbitmq_mgmt
    timeout client 10m

###############################################
# Backend для Management UI
###############################################
backend rabbitmq_mgmt
    mode tcp
    option tcp-check
    tcp-check connect
    balance leastconn

    server rabbitmq1 rabbitmq1:15672 check inter 3000 rise 2 fall 3
    server rabbitmq2 rabbitmq2:15672 check inter 3000 rise 2 fall 3 backup
    server rabbitmq3 rabbitmq3:15672 check inter 3000 rise 2 fall 3 backup

    timeout server 10m

###############################################
# Frontend для Web MQTT (порт 15675)
###############################################
frontend web_mqtt
    bind *:15675
    default_backend rabbitmq_web_mqtt
    timeout client 1h
    timeout tunnel 1h

###############################################
# Backend для Web MQTT
###############################################
backend rabbitmq_web_mqtt
    mode tcp
    option tcp-check
    tcp-check connect
    balance leastconn

    server rabbitmq1 rabbitmq1:15675 check inter 3000 rise 2 fall 3
    server rabbitmq2 rabbitmq2:15675 check inter 3000 rise 2 fall 3 backup
    server rabbitmq3 rabbitmq3:15675 check inter 3000 rise 2 fall 3 backup

    timeout server 1h
    timeout tunnel 1h

###############################################
# Frontend для TCP MQTT (порт 1883)
###############################################
frontend tcp_mqtt
    bind *:1883
    default_backend rabbitmq_tcp_mqtt
    timeout client 10m

###############################################
# Backend для TCP MQTT
###############################################
backend rabbitmq_tcp_mqtt
    mode tcp
    option tcp-check
    tcp-check connect
    balance leastconn

    server rabbitmq1 rabbitmq1:1883 check inter 3000 rise 2 fall 3
    server rabbitmq2 rabbitmq2:1883 check inter 3000 rise 2 fall 3 backup
    server rabbitmq3 rabbitmq3:1883 check inter 3000 rise 2 fall 3 backup

    timeout server 10m
